import { ThemeColors } from "../theme.slint";
import { DiffLine, TextSpan } from "../structs.slint";

component SideBySideCommentLine inherits Rectangle {
    in property <ThemeColors> theme;
    in property <DiffLine> line;

    background: theme.comment-bg;
    clip: true;

    // Left border indicator
    Rectangle {
        x: 0;
        y: 0;
        width: 4px;
        height: 100%;
        background: line.comment-is-reply ? theme.comment-border : theme.comment-author;
    }

    VerticalLayout {
        padding-left: line.comment-is-reply ? 32px : 16px;
        padding-right: 16px;
        padding-top: 8px;
        padding-bottom: 8px;
        spacing: 4px;

        // Author and timestamp header
        HorizontalLayout {
            spacing: 8px;
            alignment: start;

            Text {
                text: line.comment-author;
                color: theme.comment-author;
                font-size: 12px;
                font-weight: 600;
            }

            Text {
                text: line.comment-timestamp;
                color: theme.comment-timestamp;
                font-size: 11px;
                vertical-alignment: center;
            }
        }

        // Comment body with word wrap
        Text {
            text: line.comment-body;
            color: theme.comment-body;
            font-size: 13px;
            wrap: word-wrap;
            horizontal-stretch: 1;
        }
    }
}

component SideLine inherits Rectangle {
    in property <ThemeColors> theme;
    in property <string> line-num;
    in property <string> content;
    in property <string> line-type; // "add", "remove", "context", "empty"
    in property <[TextSpan]> spans: [];
    in property <length> font-size: 13px;

    background: line-type == "add" ? theme.diff-add-bg :
                line-type == "remove" ? theme.diff-remove-bg :
                line-type == "empty" ? theme.bg-tertiary :
                theme.diff-context-bg;

    HorizontalLayout {
        // Gutter
        Rectangle {
            width: 50px;
            background: line-type == "add" ? theme.diff-add-gutter :
                        line-type == "remove" ? theme.diff-remove-gutter :
                        line-type == "empty" ? theme.bg-tertiary :
                        theme.bg-secondary;

            Text {
                text: line-num;
                color: theme.text-muted;
                font-size: 12px;
                horizontal-alignment: right;
                vertical-alignment: center;
                x: 0;
                width: parent.width - 8px;
            }
        }

        // Sign column
        Rectangle {
            width: 20px;

            Text {
                text: line-type == "add" ? "+" :
                      line-type == "remove" ? "-" : " ";
                color: line-type == "add" ? theme.diff-add-text :
                       line-type == "remove" ? theme.diff-remove-text :
                       theme.text-muted;
                font-size: root.font-size;
                font-weight: 600;
                horizontal-alignment: center;
                vertical-alignment: center;
            }
        }

        // Code content - render spans with syntax highlighting
        Rectangle {
            horizontal-stretch: 1;
            clip: true;

            HorizontalLayout {
                x: 8px;
                alignment: start;
                spacing: 0px;

                // Render syntax-highlighted spans if available
                for span in spans: Text {
                    text: span.text;
                    color: span.color;
                    font-size: root.font-size;
                    font-family: "monospace";
                }

                // Fallback to plain content when no spans
                if spans.length == 0: Text {
                    text: content;
                    color: line-type == "add" ? theme.diff-add-text :
                           line-type == "remove" ? theme.diff-remove-text :
                           line-type == "empty" ? transparent :
                           theme.text-primary;
                    font-size: root.font-size;
                    font-family: "monospace";
                }
            }
        }
    }
}

component LeftLineItem inherits Rectangle {
    in property <ThemeColors> theme;
    in property <DiffLine> line;
    in property <length> font-size: 13px;

    height: line.line-type == "comment" ? 80px : root.font-size * 1.7;

    SideBySideCommentLine {
        theme: root.theme;
        line: root.line;
        visible: root.line.line-type == "comment";
        width: 100%;
        height: 100%;
    }

    SideLine {
        theme: root.theme;
        visible: root.line.line-type != "comment";
        line-num: root.line.old-line-num;
        content: root.line.line-type == "add" ? "" : root.line.content;
        line-type: root.line.line-type == "add" ? "empty" :
                   root.line.line-type == "hunk" ? "context" :
                   root.line.line-type;
        spans: root.line.line-type == "add" ? [] : root.line.spans;
        font-size: root.font-size;
        width: 100%;
        height: 100%;
    }
}

component RightLineItem inherits Rectangle {
    in property <ThemeColors> theme;
    in property <DiffLine> line;
    in property <length> font-size: 13px;

    height: line.line-type == "comment" ? 80px : root.font-size * 1.7;

    SideBySideCommentLine {
        theme: root.theme;
        line: root.line;
        visible: root.line.line-type == "comment";
        width: 100%;
        height: 100%;
    }

    SideLine {
        theme: root.theme;
        visible: root.line.line-type != "comment";
        line-num: root.line.new-line-num;
        content: root.line.line-type == "remove" ? "" : root.line.content;
        line-type: root.line.line-type == "remove" ? "empty" :
                   root.line.line-type == "hunk" ? "context" :
                   root.line.line-type;
        spans: root.line.line-type == "remove" ? [] : root.line.spans;
        font-size: root.font-size;
        width: 100%;
        height: 100%;
    }
}

export component SideBySideView inherits Rectangle {
    in property <ThemeColors> theme;
    in property <[DiffLine]> lines;
    in property <length> font-size: 13px;

    background: theme.bg-primary;

    HorizontalLayout {
        // Left panel (old file)
        Rectangle {
            background: theme.bg-primary;

            // Panel header
            Rectangle {
                y: 0;
                height: 32px;
                background: theme.bg-secondary;

                Rectangle {
                    y: parent.height - 1px;
                    height: 1px;
                    background: theme.border-subtle;
                }

                HorizontalLayout {
                    padding-left: 16px;
                    alignment: start;

                    Text {
                        text: "Original";
                        color: theme.text-secondary;
                        font-size: 12px;
                        font-weight: 500;
                        vertical-alignment: center;
                    }
                }
            }

            // Left diff content
            Flickable {
                y: 32px;
                height: parent.height - 32px;
                viewport-width: max(self.width, 1000px);

                VerticalLayout {
                    for line in lines: LeftLineItem {
                        theme: root.theme;
                        line: line;
                        font-size: root.font-size;
                        width: parent.width;
                    }
                }
            }
        }

        // Divider
        Rectangle {
            width: 1px;
            background: theme.border-normal;
        }

        // Right panel (new file)
        Rectangle {
            background: theme.bg-primary;

            // Panel header
            Rectangle {
                y: 0;
                height: 32px;
                background: theme.bg-secondary;

                Rectangle {
                    y: parent.height - 1px;
                    height: 1px;
                    background: theme.border-subtle;
                }

                HorizontalLayout {
                    padding-left: 16px;
                    alignment: start;

                    Text {
                        text: "Modified";
                        color: theme.text-secondary;
                        font-size: 12px;
                        font-weight: 500;
                        vertical-alignment: center;
                    }
                }
            }

            // Right diff content
            Flickable {
                y: 32px;
                height: parent.height - 32px;
                viewport-width: max(self.width, 1000px);

                VerticalLayout {
                    for line in lines: RightLineItem {
                        theme: root.theme;
                        line: line;
                        font-size: root.font-size;
                        width: parent.width;
                    }
                }
            }
        }
    }
}
