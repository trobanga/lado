import { ThemeColors } from "../theme.slint";
import { FileEntry } from "../structs.slint";

// File status indicator
component StatusBadge inherits Rectangle {
    in property <ThemeColors> theme;
    in property <string> status; // "added", "modified", "deleted"

    width: 8px;
    height: 8px;
    border-radius: 4px;
    background: status == "added" ? theme.status-added :
                status == "deleted" ? theme.status-deleted :
                theme.status-modified;
}

// Individual file/folder item
component TreeItem inherits Rectangle {
    in property <ThemeColors> theme;
    in property <string> name;
    in property <string> path;
    in property <int> depth;
    in property <bool> is-folder;
    in property <bool> is-expanded: true;
    in property <string> status: "modified";
    in property <bool> selected: false;
    in property <bool> focused: false;

    callback clicked;
    callback toggle-expand;

    height: 28px;
    background: selected ? theme.bg-selected :
                focused ? theme.bg-hover :
                (touch.has-hover ? theme.bg-hover : transparent);
    border-width: focused && !selected ? 1px : 0;
    border-color: theme.accent-primary;

    HorizontalLayout {
        padding-left: 12px + (depth * 16px);
        padding-right: 12px;
        spacing: 8px;
        alignment: start;

        // Expand/collapse indicator for folders
        if is-folder: Rectangle {
            width: 16px;
            height: 16px;

            Text {
                text: is-expanded ? "v" : ">";
                color: theme.text-muted;
                font-size: 10px;
                horizontal-alignment: center;
                vertical-alignment: center;
            }

            TouchArea {
                mouse-cursor: pointer;
                clicked => { root.toggle-expand(); }
            }
        }

        // File/folder icon placeholder
        Rectangle {
            width: 16px;
            height: 16px;
            background: is-folder ? theme.accent-secondary : transparent;
            border-radius: 2px;
            opacity: 0.3;
        }

        // Name
        Text {
            text: name;
            color: selected ? theme.text-primary : theme.text-secondary;
            font-size: 13px;
            vertical-alignment: center;
            overflow: elide;
        }

        Rectangle { }

        // Status badge for files
        if !is-folder: StatusBadge {
            theme: root.theme;
            status: root.status;
        }
    }

    touch := TouchArea {
        mouse-cursor: pointer;
        clicked => { root.clicked(); }
    }
}

export component FileTree inherits Rectangle {
    in property <ThemeColors> theme;
    in-out property <string> selected-file;
    in property <[FileEntry]> files: [];
    in property <int> focused-index: -1;

    callback file-clicked(string);

    background: transparent;

    VerticalLayout {
        padding-top: 8px;

        // Header
        Rectangle {
            height: 40px;

            HorizontalLayout {
                padding-left: 16px;
                padding-right: 16px;
                alignment: start;

                Text {
                    text: "Changed Files";
                    color: theme.text-primary;
                    font-size: 13px;
                    font-weight: 500;
                    vertical-alignment: center;
                }
            }
        }

        // File list
        Flickable {
            vertical-stretch: 1;
            viewport-height: files.length * 28px;

            VerticalLayout {
                for file[idx] in files: TreeItem {
                    theme: root.theme;
                    name: file.name;
                    path: file.path;
                    depth: file.depth;
                    is-folder: file.is-folder;
                    is-expanded: file.is-expanded;
                    status: file.status;
                    selected: file.path == selected-file;
                    focused: idx == root.focused-index;

                    clicked => {
                        if (!file.is-folder) {
                            root.file-clicked(file.path);
                        }
                    }
                }
            }
        }
    }
}
