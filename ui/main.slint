import { ThemeColors, ThemePresets } from "theme.slint";
import { FileEntry, DiffLine, PrCommitEntry, TextSpan } from "structs.slint";
import { FileTree } from "components/file_tree.slint";
import { DiffView } from "components/diff_view.slint";
import { Toolbar } from "components/toolbar.slint";
import { CommitList } from "components/commit_list.slint";
import { SettingsPanel, AppSettings } from "components/settings_panel.slint";

// Re-export structs for Rust access
export { FileEntry, DiffLine, PrCommitEntry, TextSpan, AppSettings, ThemeColors }

export component MainWindow inherits Window {
    title: "lado";
    background: root.theme.bg-primary;
    preferred-width: 1400px;
    preferred-height: 900px;
    min-width: 800px;
    min-height: 600px;
    default-font-family: "IBM Plex Sans";
    default-font-size: 13px;

    // Theme property - dynamic, derived from theme-name
    in-out property <string> theme-name: "dark";
    in-out property <ThemeColors> theme:
        theme-name == "light" ? ThemePresets.light() :
        theme-name == "solarized-dark" ? ThemePresets.solarized-dark() :
        theme-name == "solarized-light" ? ThemePresets.solarized-light() :
        ThemePresets.dark();

    in-out property <bool> side-by-side-mode: false;
    in-out property <string> selected-file: "";
    in-out property <string> diff-title: "No diff loaded";
    in-out property <[FileEntry]> files: [];
    in-out property <[DiffLine]> lines: [];
    in-out property <[PrCommitEntry]> commits: [];
    in-out property <int> selected-commit-index: -1;
    in-out property <bool> settings-visible: false;
    in-out property <AppSettings> app-settings: {
        ui-theme: "dark",
        syntax-theme: "base16-ocean.dark",
        font-size: 13,
        tab-width: 4,
        line-wrap: false,
        key-unified: "u",
        key-side-by-side: "s",
        key-scroll-down: "j",
        key-scroll-up: "k",
        key-file-next: "J",
        key-file-prev: "K",
        key-prev-commit: "[",
        key-next-commit: "]",
    };
    in-out property <int> focused-index: 0;

    // Callbacks for Rust integration
    callback file-selected(string);
    callback toggle-view-mode();
    callback refresh-diff();
    callback commit-selected(int);
    callback settings-changed(AppSettings);

    init => {
        main-focus.focus();
    }

    // Scroll step for keyboard navigation
    property <length> scroll-step: 60px;

    // Global keyboard navigation
    main-focus := FocusScope {
        key-pressed(event) => {
            // Skip keyboard navigation when settings panel is open
            if (root.settings-visible) {
                return reject;
            }

            // DIFF SCROLLING (j/k)
            if (event.text == root.app-settings.key-scroll-down) {
                diff-view.scroll-position = diff-view.scroll-position + root.scroll-step;
                return accept;
            }
            if (event.text == root.app-settings.key-scroll-up) {
                diff-view.scroll-position = max(0px, diff-view.scroll-position - root.scroll-step);
                return accept;
            }

            // FILE NAVIGATION (J/K - uppercase/shift)
            if (event.text == root.app-settings.key-file-next) {
                root.focused-index = min(root.focused-index + 1, root.files.length - 1);
                if (!root.files[root.focused-index].is-folder) {
                    root.selected-file = root.files[root.focused-index].path;
                    root.file-selected(root.selected-file);
                }
                return accept;
            }
            if (event.text == root.app-settings.key-file-prev) {
                root.focused-index = max(root.focused-index - 1, 0);
                if (!root.files[root.focused-index].is-folder) {
                    root.selected-file = root.files[root.focused-index].path;
                    root.file-selected(root.selected-file);
                }
                return accept;
            }

            // COMMIT NAVIGATION ([ / ])
            if (root.commits.length > 0) {
                if (event.text == root.app-settings.key-prev-commit) {
                    if (root.selected-commit-index >= 0) {
                        root.selected-commit-index = root.selected-commit-index - 1;
                        root.commit-selected(root.selected-commit-index);
                    }
                    return accept;
                }
                if (event.text == root.app-settings.key-next-commit) {
                    if (root.selected-commit-index < root.commits.length - 1) {
                        root.selected-commit-index = root.selected-commit-index + 1;
                        root.commit-selected(root.selected-commit-index);
                    }
                    return accept;
                }
            }

            if (event.text == Key.Return) {
                if (root.focused-index >= 0 && root.focused-index < root.files.length) {
                    if (!root.files[root.focused-index].is-folder) {
                        root.selected-file = root.files[root.focused-index].path;
                        root.file-selected(root.selected-file);
                    }
                }
                return accept;
            }
            // Use configurable keybindings for view switching
            if (event.text == root.app-settings.key-unified && root.side-by-side-mode) {
                root.side-by-side-mode = false;
                return accept;
            }
            if (event.text == root.app-settings.key-side-by-side && !root.side-by-side-mode) {
                root.side-by-side-mode = true;
                return accept;
            }
            reject
        }

        VerticalLayout {
            // Toolbar
            Toolbar {
                theme: root.theme;
                side-by-side: root.side-by-side-mode;
                diff-title: root.diff-title;
                toggle-view => {
                    root.side-by-side-mode = !root.side-by-side-mode;
                    root.toggle-view-mode();
                }
                refresh => {
                    root.refresh-diff();
                }
                open-settings => {
                    root.settings-visible = true;
                }
            }

            // Main content area
            HorizontalLayout {
                vertical-stretch: 1;

                // File tree panel
                Rectangle {
                    width: 280px;
                    vertical-stretch: 1;
                    background: root.theme.bg-secondary;

                    Rectangle {
                        x: parent.width - 1px;
                        width: 1px;
                        background: root.theme.border-subtle;
                    }

                    VerticalLayout {
                        // Commit list (collapsible, above file tree)
                        CommitList {
                            theme: root.theme;
                            commits: root.commits;
                            selected-index: root.selected-commit-index;
                            commit-selected(idx) => {
                                root.selected-commit-index = idx;
                                root.commit-selected(idx);
                            }
                        }

                        // File tree
                        FileTree {
                            theme: root.theme;
                            selected-file: root.selected-file;
                            files: root.files;
                            focused-index: root.focused-index;
                            file-clicked(path) => {
                                root.selected-file = path;
                                root.file-selected(path);
                            }
                        }
                    }
                }

                // Diff view area
                diff-view := DiffView {
                    horizontal-stretch: 1;
                    vertical-stretch: 1;
                    theme: root.theme;
                    side-by-side: root.side-by-side-mode;
                    selected-file: root.selected-file;
                    lines: root.lines;
                    font-size: root.app-settings.font-size * 1px;
                    scroll-step: root.scroll-step;
                }
            }
        }
    }

    // Settings panel overlay (slides in from right)
    SettingsPanel {
        theme: root.theme;
        panel-visible: root.settings-visible;
        container-width: root.width;
        height: root.height;
        settings: root.app-settings;
        settings-changed(s) => {
            root.app-settings = s;
            // Update theme based on ui-theme setting
            if (s.ui-theme == "dark") {
                root.theme = ThemePresets.dark();
            } else if (s.ui-theme == "light") {
                root.theme = ThemePresets.light();
            } else if (s.ui-theme == "solarized-dark") {
                root.theme = ThemePresets.solarized-dark();
            } else if (s.ui-theme == "solarized-light") {
                root.theme = ThemePresets.solarized-light();
            }
            root.theme-name = s.ui-theme;
            root.settings-changed(s);
        }
        close-panel => {
            root.settings-visible = false;
        }
    }
}
